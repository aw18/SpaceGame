<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <style>
            canvas {
                border:1px solid #000000;
                background-color: #040220;
            }
            </style>
    </head>
    <body onload="startGame()">
        <script>
            var score;
            var spaceShip;
            var listOfAliens = [];
            var background;

            function startGame(){
                gameArea.start();
                score = new scoreComponent("20px", "Arial", "yellow", 200, 30, 0);
                spaceShip = new spaceShip(15, "yellow", 150, 485);
                background = new backgroundComponent(gameArea.canvas.width, 
                gameArea.canvas.height, "milkyway_bg.jpg", 0, 0);
                spawnAliens(5, 50);
            }

            function spawnAliens(numberOfAliens, length){

                for (let i = 0; i < numberOfAliens; i++){
                    var x = Math.floor(Math.random() * gameArea.canvas.width);
                    var y = Math.floor(Math.random() * (gameArea.canvas.height / 5));

                    if (x - length < 0)
                    {
                        x += length;
                        console.log("added " + length + " => " + x);
                    }

                    if (x + length > gameArea.canvas.width)
                    {
                        x -= length;
                        console.log("subtracted " + length + " => " + x);
                    }

                    console.log("x: " + x);
                    // var alien = new component(i, length, length, "orange", x, y);
                    var alien = new component(i, length, length, "transp-pinkorb.png", "transp-pinkorb-darker.png", x, y, 'image');
                    listOfAliens.push(alien);
                }
            }

            let gameArea = {
                canvas : document.createElement("canvas"),
                start : function() {
                    this.canvas.width = 300;
                    this.canvas.height = 500;
                    this.context = this.canvas.getContext("2d");
                    document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                    // every 20th milliseconds, 50 times per second
                    this.frameNo = 0;
                    this.interval = setInterval(updateGameArea, 20);

                    // keyboard arrows controller
                    window.addEventListener('keydown', function(e){
                        gameArea.key = e.keyCode;
                    });
                    window.addEventListener('keyup', function(e){
                        gameArea.key = false;
                    })

                    // touchscreen controllers
                    window.addEventListener('touchmove', function(e){
                        gameArea.x = e.touches[0].screenX;
                        gameArea.y = e.touches[0].screenY;
                    });
                },
                clear : function() {
                    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                },
                stop : function() {
                    clearInterval(this.interval);
                }
            }

            function component(id, width, height, color, color2, x, y, type) {
                this.id = id;
                this.width = width;
                this.height = height;
                this.x = x;
                this.y = y;
                this.type = type;
                if (type == "image")
                {
                    this.toggle = true;
                    this.image1 = new Image();
                    this.image2 = new Image();
                    this.image1.src = color;
                    this.image2.src = color2;
                    this.currentImage = this.image1;
                }

                this.update = function(){
                    ctx = gameArea.context;
                    if (type == "image"){

                        if ((gameArea.frameNo % 10) == 0){
                            if (this.toggle){
                                this.currentImage = this.image1;
                                this.toggle = false;
                                console.log("id:" + id + " - image1 - frameNo: " + gameArea.frameNo);
                            }
                            else{
                                this.currentImage = this.image2;
                                this.toggle = true;
                                console.log("id:" + id + " - image2 - frameNo: " + gameArea.frameNo);
                            }
                        }

                        ctx.drawImage(this.currentImage, 
                        this.x, 
                        this.y,
                        this.width, this.height);
                    }
                    else{
                        ctx.fillStyle = color;
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                    }
                }
            }

            function scoreComponent(pixelSize, font, colour, x, y, value){
                this.font = pixelSize + " " + font;
                this.colour = colour;
                this.x = x;
                this.y = y;
                this.value = value;
                
                this.update = function(){
                    ctx = gameArea.context;
                    ctx.font = this.font;
                    ctx.fillStyle = this.colour;
                    ctx.fillText(this.text, this.x, this.y);
                }
            }

            function backgroundComponent(width, height, url, x, y){
                this.width = width;
                this.height = height;
                this.url = url;
                this.x = x;
                this.y = y;
                this.image = new Image();
                this.image.src = url;

                this.update = function(){
                    ctx = gameArea.context;
                    ctx.drawImage(this.image,
                    this.x, 
                    this.y,
                    this.width, 
                    this.height);
                }
            }

            function spaceShip(radius, colour, x, y){
                this.radius = radius;
                this.colour = colour; 
                this.x = x;
                this.y = y;
                this.speedX = 0;
                this.speedY = 0;

                this.update = function(){
                    ctx = gameArea.context;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, 2*Math.PI, false);
                    ctx.fillStyle = this.colour;
                    ctx.fill();
                    ctx.lineWidth = 5;
                    ctx.strokeStyle = "#003300";
                    ctx.stroke();
                }

                this.newPos = function(){
                    this.x += this.speedX;
                    this.y += this.speedY;
                }

                this.crashWith = function(otherobj){
                    var dx = this.x - otherobj.x; 
                    var dy = this.y - otherobj.y;
                    var distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < this.radius + (otherobj.width / 2) ){
                        // collision detected
                        return true;
                    }

                    return false;
                }
            }

            function updateGameArea(){
                listOfAliens.forEach(function(alien){
                    if (spaceShip.crashWith(alien)){
                        gameArea.stop();
                    }
                });

                gameArea.clear();

                gameArea.frameNo += 1;

                score.text = "SCORE: " + score.value;
                score.update();

                background.update();

                // keyboard controllers updating
                spaceShip.speedX = 0;
                spaceShip.speedY = 0;
                if (gameArea.key && gameArea.key == 37){
                    spaceShip.speedX = -1;
                }
                if (gameArea.key && gameArea.key == 39) {
                    spaceShip.speedX = 1; 
                }
                // if (gameArea.key && gameArea.key == 38) {
                //     spaceShip.speedY = -1; 
                // }
                // if (gameArea.key && gameArea.key == 40) {
                //     spaceShip.speedY = 1; 
                // }

                // touchscreen controllers updating 
                if (gameArea.x && gameArea.y){
                    spaceShip.x = gameArea.x;
                    spaceShip.y = gameArea.y;
                }

                spaceShip.newPos();
                spaceShip.update();
                
                listOfAliens.forEach(function(alien){
                    alien.y += Math.random();
                    alien.update();
                });              
            }

        </script>
        <h1> Space Game </h1>
    </body>
</html>